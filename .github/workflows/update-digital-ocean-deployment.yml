name: Update DigitalOcean Deployment
on:
  push:
    branches:
      - main
jobs:
  update-deployment:
    name: Update DigitalOcean Deployment
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install doctl package
        run: sudo snap install doctl

      - name: Setup Node.js 22.x
        uses: actions/setup-node@v4
        with:
          node-version: 22

      - name: Install dependencies
        run: npm install

      - name: Authenticate doctl
        run: doctl auth init -t ${{ secrets.DIGITALOCEAN_API_KEY }}

      - name: Update DigitalOcean Deployment
        run: |
          doctl apps update ${{ vars.DIGITALOCEAN_IMGPROXY_APP_ID }} --spec .digitalocean/comet-starter-imgproxy.yaml
          sed -i 's/dev\.comet\-dxp\.com/comet-starter-site-tyqqf.ondigitalocean.app/g' site-configs/main.ts

          APP_ENV=dev npx -y @comet/cli inject-site-configs -f site-configs/site-configs.ts -i .digitalocean/comet-starter-cms.tpl.yaml -o .digitalocean/comet-starter-cms.yaml
          doctl apps update ${{ vars.DIGITALOCEAN_CMS_APP_ID }} --spec .digitalocean/comet-starter-cms.yaml # Configuration-Changes
          doctl apps create-deployment ${{ vars.DIGITALOCEAN_CMS_APP_ID }} # Code-Changes

          APP_ENV=dev npx -y @comet/cli inject-site-configs -f site-configs/site-configs.ts -i .digitalocean/comet-starter-site-main.tpl.yaml -o .digitalocean/comet-starter-site-main.yaml
          doctl apps update ${{ vars.DIGITALOCEAN_SITE_MAIN_APP_ID }} --spec .digitalocean/comet-starter-site-main.yaml # Configuration-Changes
          doctl apps create-deployment ${{ vars.DIGITALOCEAN_SITE_MAIN_APP_ID }} # Code-Changes
